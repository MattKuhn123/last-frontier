<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SFX Designer â€” Last Frontier</title>
    <link rel="stylesheet" href="tools.css">
    <style>
        body { padding: 50px 20px 20px; }
        h1 { margin-bottom: 16px; }
        h2 { margin-bottom: 8px; margin-top: 0; }
        .btn { font-size: 12px; padding: 6px 16px; }
        .control-row label { width: 70px; }
        .control-row .value { width: 40px; }

        /* Waveform selectors */
        .wave-btns { display: flex; gap: 4px; flex: 1; }
        .wave-btn {
            background: transparent;
            border: 1px solid #333;
            color: #888;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 3px 10px;
            cursor: pointer;
        }
        .wave-btn:hover { border-color: #666; }
        .wave-btn.active { border-color: #4f4; color: #4f4; }

        /* Waveform display */
        #waveform {
            width: 100%;
            height: 80px;
            border: 1px solid #222;
            margin-bottom: 16px;
            display: block;
        }
    </style>
</head>
<body>
    <nav class="tool-nav">
        <a href="tool-home.html">Home</a>
        <a href="player-editor.html">Player</a>
        <a href="enemies-editor.html">Enemies</a>
        <a href="wingmen-editor.html">Wingmen</a>
        <a href="boss-editor.html">Boss</a>
        <a href="sound-designer.html" class="active">Sounds</a>
        <a href="mission-editor.html">Missions</a>
        <a href="narrative-editor.html">Narrative</a>
    </nav>
    <h1>SFX Designer</h1>

    <div class="toolbar">
        <div class="action-row">
            <button class="btn btn-action" id="reset-all-btn">Reset All</button>
            <button class="btn btn-save" id="default-btn" style="display:none">Save as Default</button>
        </div>
    </div>

    <div class="editor-layout">
        <div class="unit-list-panel">
            <h2>Sounds</h2>
            <div class="unit-list" id="unit-list"></div>
            <button class="add-unit-btn" id="add-unit-btn">+ Add Sound</button>
        </div>
        <div class="detail-panel" id="detail-panel">
            <div class="no-selection">Select a sound to edit</div>
        </div>
    </div>

<script src="tools.js"></script>
<script>
// ============================================================
// DATA
// ============================================================
let soundsDefaults = {};
let soundsData = {};
let selectedKey = null;

const DEFAULT_SOUND = {
    duration: 0.4, noiseDecay: 3, noiseFilter: 600, noiseVolume: 0.6,
    toneType: 'sine', toneStart: 80, toneEnd: 30, toneDecay: 2, toneVolume: 0.5
};

// ============================================================
// UNIT LIST
// ============================================================
const listEl = document.getElementById('unit-list');
const detailEl = document.getElementById('detail-panel');

function renderList() {
    listEl.innerHTML = '';
    for (const key of Object.keys(soundsData)) {
        const item = document.createElement('div');
        item.className = 'unit-item' + (key === selectedKey ? ' selected' : '');

        const name = document.createElement('span');
        name.className = 'name';
        name.textContent = key;

        const del = document.createElement('span');
        del.className = 'delete-unit';
        del.textContent = '\u00d7';
        del.onclick = (e) => {
            e.stopPropagation();
            delete soundsData[key];
            if (selectedKey === key) { selectedKey = null; renderDetail(); }
            renderList();
        };

        item.append(name, del);
        item.onclick = () => { selectedKey = key; renderList(); renderDetail(); };
        listEl.appendChild(item);
    }
}

// ============================================================
// DETAIL PANEL
// ============================================================
function renderDetail() {
    detailEl.innerHTML = '';

    if (!selectedKey || !soundsData[selectedKey]) {
        detailEl.innerHTML = '<div class="no-selection">Select a sound to edit</div>';
        return;
    }

    const sound = soundsData[selectedKey];
    const defaults = soundsDefaults[selectedKey] || DEFAULT_SOUND;

    // --- Name (renames the key) ---
    const nameSection = makeSection('Name');
    detailEl.appendChild(nameSection);
    nameSection.appendChild(fieldRow('Key', textInput(selectedKey, newKey => {
        newKey = newKey.trim();
        if (!newKey || newKey === selectedKey || soundsData[newKey]) return;
        // Move data to new key, preserving insertion order
        const rebuilt = {};
        for (const k of Object.keys(soundsData)) {
            rebuilt[k === selectedKey ? newKey : k] = soundsData[k];
        }
        soundsData = rebuilt;
        selectedKey = newKey;
        renderList();
    })));

    // --- Noise Layer ---
    const noiseSection = makeSection('Noise Layer');
    detailEl.appendChild(noiseSection);

    sliderRow(noiseSection, 'Decay', sound.noiseDecay, 0.5, 8, 0.1,
        v => { sound.noiseDecay = v; autoRedraw(); }, defaults.noiseDecay);
    sliderRow(noiseSection, 'Filter Hz', sound.noiseFilter, 100, 8000, 50,
        v => { sound.noiseFilter = v; autoRedraw(); }, defaults.noiseFilter);
    sliderRow(noiseSection, 'Volume', sound.noiseVolume, 0, 1, 0.01,
        v => { sound.noiseVolume = v; autoRedraw(); }, defaults.noiseVolume);

    // --- Tone Layer ---
    const toneSection = makeSection('Tone Layer');
    detailEl.appendChild(toneSection);

    // Waveform type buttons
    const waveRow = document.createElement('div');
    waveRow.className = 'config-row';
    const waveLbl = document.createElement('label');
    waveLbl.textContent = 'Waveform';
    const waveBtns = document.createElement('div');
    waveBtns.className = 'wave-btns';
    for (const [type, label] of [['sine','sine'],['square','square'],['sawtooth','saw'],['triangle','tri']]) {
        const btn = document.createElement('button');
        btn.className = 'wave-btn' + (sound.toneType === type ? ' active' : '');
        btn.textContent = label;
        btn.onclick = () => {
            sound.toneType = type;
            waveBtns.querySelectorAll('.wave-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            autoRedraw();
        };
        waveBtns.appendChild(btn);
    }
    waveRow.append(waveLbl, waveBtns);
    toneSection.appendChild(waveRow);

    sliderRow(toneSection, 'Start Hz', sound.toneStart, 20, 2000, 1,
        v => { sound.toneStart = v; autoRedraw(); }, defaults.toneStart);
    sliderRow(toneSection, 'End Hz', sound.toneEnd, 20, 2000, 1,
        v => { sound.toneEnd = v; autoRedraw(); }, defaults.toneEnd);
    sliderRow(toneSection, 'Decay', sound.toneDecay, 0.5, 8, 0.1,
        v => { sound.toneDecay = v; autoRedraw(); }, defaults.toneDecay);
    sliderRow(toneSection, 'Volume', sound.toneVolume, 0, 1, 0.01,
        v => { sound.toneVolume = v; autoRedraw(); }, defaults.toneVolume);

    // --- Master ---
    const masterSection = makeSection('Master');
    detailEl.appendChild(masterSection);

    sliderRow(masterSection, 'Duration', sound.duration, 0.05, 2, 0.01,
        v => { sound.duration = v; autoRedraw(); }, defaults.duration);

    // --- Waveform canvas ---
    const canvas = document.createElement('canvas');
    canvas.id = 'waveform';
    detailEl.appendChild(canvas);

    // --- Play / Auto-play ---
    const actions = document.createElement('div');
    actions.className = 'actions';
    const playBtn = document.createElement('button');
    playBtn.className = 'btn btn-play';
    playBtn.textContent = 'Play';
    playBtn.onclick = play;
    const autoLabel = document.createElement('label');
    const autoCheck = document.createElement('input');
    autoCheck.type = 'checkbox';
    autoCheck.id = 'auto-play';
    autoLabel.append(autoCheck, ' Auto-play');
    actions.append(playBtn, autoLabel);
    detailEl.appendChild(actions);

    drawWaveform();
}

function autoRedraw() {
    drawWaveform();
    if (document.getElementById('auto-play')?.checked) play();
}

// ============================================================
// SYNTHESIS
// ============================================================
const SAMPLE_RATE = 44100;

function synthesize(params) {
    const numSamples = Math.floor(SAMPLE_RATE * params.duration);
    const samples = new Float32Array(numSamples);

    // Noise layer
    const noise = new Float32Array(numSamples);
    for (let i = 0; i < numSamples; i++) {
        const progress = i / numSamples;
        noise[i] = (Math.random() * 2 - 1) * Math.pow(1 - progress, params.noiseDecay);
    }

    // Low-pass filter (single-pole IIR)
    const alpha = Math.min(1, (2 * Math.PI * params.noiseFilter) / SAMPLE_RATE);
    let prev = 0;
    for (let i = 0; i < numSamples; i++) {
        prev += alpha * (noise[i] - prev);
        noise[i] = prev;
    }

    // Tone layer
    const tone = new Float32Array(numSamples);
    let phase = 0;
    for (let i = 0; i < numSamples; i++) {
        const progress = i / numSamples;
        const freq = params.toneStart * Math.pow(params.toneEnd / Math.max(1, params.toneStart), progress);
        const envelope = Math.pow(1 - progress, params.toneDecay);
        phase += (2 * Math.PI * freq) / SAMPLE_RATE;

        let s;
        switch (params.toneType) {
            case 'sine':     s = Math.sin(phase); break;
            case 'square':   s = Math.sin(phase) > 0 ? 1 : -1; break;
            case 'sawtooth': s = ((phase % (2 * Math.PI)) / Math.PI) - 1; break;
            case 'triangle':
                const t = (phase % (2 * Math.PI)) / (2 * Math.PI);
                s = 4 * Math.abs(t - 0.5) - 1;
                break;
            default: s = Math.sin(phase);
        }
        tone[i] = s * envelope;
    }

    // Mix
    for (let i = 0; i < numSamples; i++) {
        samples[i] = noise[i] * params.noiseVolume + tone[i] * params.toneVolume;
    }

    // Normalize
    let peak = 0;
    for (let i = 0; i < numSamples; i++) peak = Math.max(peak, Math.abs(samples[i]));
    if (peak > 0) {
        const scale = 0.9 / peak;
        for (let i = 0; i < numSamples; i++) samples[i] *= scale;
    }

    return samples;
}

// ============================================================
// PLAYBACK
// ============================================================
let audioCtx = null;

function play() {
    if (!selectedKey || !soundsData[selectedKey]) return;
    if (!audioCtx) audioCtx = new AudioContext();
    const params = soundsData[selectedKey];
    const samples = synthesize(params);

    const buffer = audioCtx.createBuffer(1, samples.length, SAMPLE_RATE);
    buffer.getChannelData(0).set(samples);

    const src = audioCtx.createBufferSource();
    src.buffer = buffer;
    src.connect(audioCtx.destination);
    src.start();
}

// ============================================================
// WAVEFORM DISPLAY
// ============================================================
function drawWaveform() {
    const canvas = document.getElementById('waveform');
    if (!canvas || !selectedKey || !soundsData[selectedKey]) return;
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth * 2;
    canvas.height = canvas.offsetHeight * 2;

    const params = soundsData[selectedKey];
    const samples = synthesize(params);

    ctx.fillStyle = '#111';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Center line
    ctx.strokeStyle = '#222';
    ctx.beginPath();
    ctx.moveTo(0, canvas.height / 2);
    ctx.lineTo(canvas.width, canvas.height / 2);
    ctx.stroke();

    // Waveform
    ctx.strokeStyle = '#4f4';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    for (let x = 0; x < canvas.width; x++) {
        const i = Math.floor((x / canvas.width) * samples.length);
        const y = (1 - samples[i]) * canvas.height / 2;
        if (x === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    }
    ctx.stroke();
}

// ============================================================
// ADD SOUND
// ============================================================
document.getElementById('add-unit-btn').onclick = () => {
    let key = 'new-sound';
    let n = 1;
    while (soundsData[key]) { key = 'new-sound-' + (n++); }
    soundsData[key] = deepCopy(DEFAULT_SOUND);
    selectedKey = key;
    renderList();
    renderDetail();
};

// ============================================================
// RESET ALL
// ============================================================
document.getElementById('reset-all-btn').onclick = () => {
    soundsData = deepCopy(soundsDefaults);
    selectedKey = null;
    renderList();
    renderDetail();
};

// ============================================================
// SAVE AS DEFAULT
// ============================================================
setupSaveDefault('default-btn', () => saveJSON('/api/save-sounds', deepCopy(soundsData)));

// ============================================================
// INIT
// ============================================================
async function init() {
    try {
        const res = await fetch('../data/sounds.json');
        soundsDefaults = await res.json();
    } catch (e) {
        console.error('Failed to load sounds data:', e);
    }

    soundsData = deepCopy(soundsDefaults);

    renderList();
    renderDetail();
}

init();
</script>
</body>
</html>
