<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enemies Editor — Last Frontier</title>
    <link rel="stylesheet" href="tools.css">
    <style>
        body { padding: 20px; }
        h1 { margin-bottom: 16px; }
        h2 { margin-bottom: 8px; margin-top: 0; }
        .btn { font-size: 12px; padding: 6px 16px; }
        .action-row input[type="text"] { width: 120px; font-size: 12px; padding: 5px 8px; }
        .control-row label { width: 70px; }
        .control-row .value { width: 40px; }

        .shape-section { margin-bottom: 16px; }
        .shape-section canvas { display: block; }
        #edit-canvas { border: 1px solid #222; cursor: crosshair; }
        #preview-canvas { border: 1px solid #222; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Enemies Editor</h1>

    <div class="toolbar">
        <h2>Presets</h2>
        <div class="preset-row" id="presets"></div>
        <div class="action-row">
            <input type="text" id="preset-name" placeholder="my-enemies">
            <button class="btn btn-save" id="save-btn">Save</button>
            <button class="btn btn-action" id="reset-all-btn">Reset All</button>
            <button class="btn btn-play" id="apply-btn">Apply to Game</button>
            <button class="btn btn-save" id="default-btn" style="display:none">Save as Default</button>
        </div>
    </div>

    <div class="editor-layout">
        <div class="unit-list-panel">
            <h2 id="list-heading">Enemies</h2>
            <div class="unit-list" id="unit-list"></div>
            <button class="add-unit-btn" id="add-unit-btn">+ Add Type</button>
        </div>
        <div class="detail-panel" id="detail-panel">
            <div class="no-selection">Select an enemy type to edit</div>
        </div>
    </div>

    <!-- Hidden shape editor elements (shown inside detail panel when an enemy is selected) -->
    <template id="detail-template">
        <div class="shape-section">
            <h2>Shape</h2>
            <div class="canvas-row">
                <div class="edit-area">
                    <canvas id="edit-canvas" width="300" height="300"></canvas>
                    <div class="edit-hint">Click to add &middot; Drag to move &middot; Right-click to delete</div>
                </div>
                <div class="preview-area">
                    <canvas id="preview-canvas" width="120" height="120"></canvas>
                    <div style="margin-top: 8px;">
                        <div class="vertex-list" id="vertex-list"></div>
                    </div>
                </div>
            </div>
            <div class="actions">
                <button class="btn btn-danger" id="clear-btn">Clear</button>
                <button class="btn btn-action" id="reset-shape-btn">Reset Shape</button>
                <label><input type="checkbox" id="snap-toggle" checked> Snap</label>
                <label><input type="checkbox" id="symmetry-toggle"> Symmetry</label>
            </div>
        </div>
        <div class="section">
            <h2>Properties</h2>
            <div id="props-container"></div>
        </div>
    </template>

<script src="tools.js"></script>
<script src="shape-editor.js"></script>
<script>
// ============================================================
// DATA
// ============================================================
let enemiesDefaults = {};
let enemiesData = {};
let selectedKey = null;
let currentShapeEditor = null;

// ============================================================
// UNIT LIST
// ============================================================
const listEl = document.getElementById('unit-list');
const detailEl = document.getElementById('detail-panel');

function renderList() {
    listEl.innerHTML = '';
    const keys = Object.keys(enemiesData);

    for (const key of keys) {
        const unit = enemiesData[key];
        const item = document.createElement('div');
        item.className = 'unit-item' + (key === selectedKey ? ' selected' : '');

        const swatch = document.createElement('span');
        swatch.className = 'swatch';
        swatch.style.background = unit.color;

        const name = document.createElement('span');
        name.className = 'name';
        name.textContent = unit.name || key;

        const del = document.createElement('span');
        del.className = 'delete-unit';
        del.textContent = '\u00d7';
        del.onclick = (e) => {
            e.stopPropagation();
            delete enemiesData[key];
            if (selectedKey === key) selectedKey = null;
            renderList();
            renderDetail();
        };

        item.append(swatch, name, del);
        item.onclick = () => { selectedKey = key; renderList(); renderDetail(); };
        listEl.appendChild(item);
    }
}

// ============================================================
// DETAIL PANEL
// ============================================================
function renderDetail() {
    // Stop previous shape editor preview
    if (currentShapeEditor) {
        currentShapeEditor.stopPreview();
        currentShapeEditor = null;
    }

    detailEl.innerHTML = '';

    if (!selectedKey || !enemiesData[selectedKey]) {
        detailEl.innerHTML = '<div class="no-selection">Select an enemy type to edit</div>';
        return;
    }

    const unit = enemiesData[selectedKey];

    // Ensure shape array exists
    if (!unit.shape) {
        const defUnit = enemiesDefaults[selectedKey];
        unit.shape = defUnit ? defUnit.shape.map(v => [...v]) : [[0,-1],[-0.8,0.3],[-0.4,0.7],[0,0.4],[0.4,0.7],[0.8,0.3]];
    }

    // Clone template content
    const template = document.getElementById('detail-template');
    const content = template.content.cloneNode(true);
    detailEl.appendChild(content);

    // Wire up shape editor
    const editCanvas = detailEl.querySelector('#edit-canvas');
    const previewCanvas = detailEl.querySelector('#preview-canvas');

    currentShapeEditor = createShapeEditor({
        editCanvas,
        previewCanvas,
        vertexListEl:     detailEl.querySelector('#vertex-list'),
        snapToggleEl:     detailEl.querySelector('#snap-toggle'),
        symmetryToggleEl: detailEl.querySelector('#symmetry-toggle'),
        getVertices:      () => unit.shape,
        setVertices:      (v) => { unit.shape = v; },
        previewColor:     () => unit.color,
        previewSize:      () => unit.size || 12,
        previewLineWidth: () => 1.5,
        previewLabel:     () => unit.name || selectedKey.toUpperCase()
    });

    detailEl.querySelector('#clear-btn').onclick = () => currentShapeEditor.clear();
    detailEl.querySelector('#reset-shape-btn').onclick = () => {
        const defUnit = enemiesDefaults[selectedKey];
        const defShape = defUnit ? defUnit.shape : [[0,-1],[-0.8,0.3],[-0.4,0.7],[0,0.4],[0.4,0.7],[0.8,0.3]];
        currentShapeEditor.reset(defShape);
    };

    // Properties
    const propsEl = detailEl.querySelector('#props-container');

    // Name
    propsEl.appendChild(fieldRow('Name', textInput(unit.name || '', v => { unit.name = v; renderList(); })));

    // Color
    propsEl.appendChild(fieldRow('Color', colorInput(unit.color, v => { unit.color = v; renderList(); })));

    // Size
    sliderRow(propsEl, 'Size', unit.size || 12, 5, 40, 1,
        v => { unit.size = v; },
        (enemiesDefaults[selectedKey] || {}).size || 12);

    // Speed
    sliderRow(propsEl, 'Speed', unit.speed || 1, 0.1, 5, 0.1,
        v => { unit.speed = v; },
        (enemiesDefaults[selectedKey] || {}).speed || 1);

    // Turn Speed
    sliderRow(propsEl, 'Turn Speed', unit.turnSpeed || 0.04, 0.01, 0.1, 0.005,
        v => { unit.turnSpeed = v; },
        (enemiesDefaults[selectedKey] || {}).turnSpeed || 0.04);

    // Fire Interval
    sliderRow(propsEl, 'Fire Interval', unit.fireInterval || 90, 10, 300, 5,
        v => { unit.fireInterval = v; },
        (enemiesDefaults[selectedKey] || {}).fireInterval || 90);

    // Bullet Speed
    sliderRow(propsEl, 'Bullet Speed', unit.bulletSpeed || 4, 1, 15, 0.5,
        v => { unit.bulletSpeed = v; },
        (enemiesDefaults[selectedKey] || {}).bulletSpeed || 4);

    currentShapeEditor.refresh();
    currentShapeEditor.startPreview();
}

// ============================================================
// ADD UNIT
// ============================================================
document.getElementById('add-unit-btn').onclick = () => {
    let key = 'new-type';
    let n = 1;
    while (enemiesData[key]) { key = 'new-type-' + (n++); }
    enemiesData[key] = {
        name: key.toUpperCase(),
        color: '#fff',
        size: 12,
        speed: 1.0,
        turnSpeed: 0.04,
        fireInterval: 90,
        bulletSpeed: 4,
        shape: [[0,-1],[-0.8,0.3],[-0.4,0.7],[0,0.4],[0.4,0.7],[0.8,0.3]]
    };
    selectedKey = key;
    renderList();
    renderDetail();
};

// ============================================================
// PRESETS
// ============================================================
const presets = setupPresets({
    container: 'presets',
    storageKey: 'enemies-presets',
    getData: () => deepCopy(enemiesData),
    setData: (data) => {
        enemiesData = deepCopy(data);
        selectedKey = null;
        renderList();
        renderDetail();
    },
    saveInput: 'preset-name',
    saveBtn: 'save-btn'
});
const renderPresets = presets.render;

document.getElementById('reset-all-btn').onclick = () => {
    enemiesData = deepCopy(enemiesDefaults);
    selectedKey = null;
    renderList();
    renderDetail();
};

// ============================================================
// APPLY TO GAME
// ============================================================
document.getElementById('apply-btn').onclick = () => {
    // Diff each enemy type
    const diff = {};
    for (const key of Object.keys(enemiesData)) {
        const cur = enemiesData[key];
        const def = enemiesDefaults[key];
        if (!def) {
            // New type — include entirely
            diff[key] = deepCopy(cur);
            continue;
        }
        const typeDiff = {};
        for (const prop of Object.keys(cur)) {
            if (prop === 'shape') {
                const changed = cur.shape.length !== def.shape.length ||
                    cur.shape.some((v, i) => v[0] !== def.shape[i][0] || v[1] !== def.shape[i][1]);
                if (changed) typeDiff.shape = cur.shape.map(v => [Math.round(v[0]*100)/100, Math.round(v[1]*100)/100]);
            } else if (JSON.stringify(cur[prop]) !== JSON.stringify(def[prop])) {
                typeDiff[prop] = cur[prop];
            }
        }
        if (Object.keys(typeDiff).length > 0) diff[key] = typeDiff;
    }
    // Check for deleted types
    for (const key of Object.keys(enemiesDefaults)) {
        if (!enemiesData[key]) {
            diff[key] = null; // signal deletion
        }
    }

    if (Object.keys(diff).length === 0) {
        localStorage.removeItem('lf-mod-enemies');
        flashButton('apply-btn', 'Cleared!');
    } else {
        localStorage.setItem('lf-mod-enemies', JSON.stringify(diff));
        flashButton('apply-btn', 'Applied!');
    }
};

// ============================================================
// SAVE AS DEFAULT
// ============================================================
setupSaveDefault('default-btn', () => saveJSON('/api/save-enemies', deepCopy(enemiesData)));

// ============================================================
// INIT
// ============================================================
async function init() {
    try {
        const res = await fetch('../data/enemies.json');
        enemiesDefaults = await res.json();
    } catch (e) {
        console.error('Failed to load enemies data:', e);
    }

    enemiesData = deepCopy(enemiesDefaults);

    try {
        const mod = JSON.parse(localStorage.getItem('lf-mod-enemies'));
        if (mod && typeof mod === 'object') {
            for (const key of Object.keys(mod)) {
                if (mod[key] === null) {
                    delete enemiesData[key];
                } else if (enemiesData[key]) {
                    deepAssign(enemiesData[key], mod[key]);
                } else {
                    enemiesData[key] = deepCopy(mod[key]);
                }
            }
        }
    } catch {}

    renderList();
    renderDetail();
    renderPresets();
}

init();
</script>
</body>
</html>
