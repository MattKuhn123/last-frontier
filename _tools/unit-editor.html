<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Unit Editor — Last Frontier</title>
    <link rel="stylesheet" href="tools.css">
    <style>
        body { padding: 20px; }
        h1 { margin-bottom: 16px; }
        h2 { margin-bottom: 8px; margin-top: 0; }
        .btn { font-size: 12px; padding: 6px 16px; }
        .action-row input[type="text"] { width: 120px; font-size: 12px; padding: 5px 8px; }

        .toolbar {
            margin-bottom: 20px;
            border-bottom: 1px solid #222;
            padding-bottom: 12px;
        }

        /* --- Tabs --- */
        .tab-bar {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
        }
        .tab-btn {
            background: transparent;
            border: 1px solid #333;
            border-bottom: none;
            color: #666;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 8px 24px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .tab-btn:hover { color: #ccc; }
        .tab-btn.active {
            color: #4f4;
            border-color: #4f4;
            border-bottom: 1px solid #111;
            margin-bottom: -1px;
            z-index: 1;
        }
        .tab-content {
            border-top: 1px solid #333;
            padding-top: 16px;
        }

        /* --- Unit List + Detail Layout --- */
        .editor-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .unit-list-panel {
            width: 200px;
            flex-shrink: 0;
        }
        .unit-list {
            border: 1px solid #222;
            background: #0a0a0a;
            min-height: 60px;
        }
        .unit-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid #1a1a1a;
            user-select: none;
        }
        .unit-item:hover { background: #1a1a1a; }
        .unit-item.selected { background: #1a2a1a; border-left: 2px solid #4f4; }
        .unit-item .swatch {
            width: 12px;
            height: 12px;
            border: 1px solid #444;
            flex-shrink: 0;
        }
        .unit-item .name {
            flex: 1;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .unit-item .delete-unit {
            color: #444;
            cursor: pointer;
            font-size: 14px;
            flex-shrink: 0;
            padding: 0 2px;
        }
        .unit-item .delete-unit:hover { color: #f44; }
        .add-unit-btn {
            width: 100%;
            padding: 8px;
            background: transparent;
            border: 1px dashed #333;
            color: #666;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            cursor: pointer;
        }
        .add-unit-btn:hover { border-color: #4f4; color: #4f4; }

        /* --- Detail Panel --- */
        .detail-panel {
            flex: 1;
            min-width: 0;
        }
        .detail-panel .section {
            border: 1px solid #222;
            padding: 14px 16px;
            margin-bottom: 12px;
        }
        .field-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .field-row label {
            width: 130px;
            flex-shrink: 0;
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
        }
        .field-row input[type="text"],
        .field-row input[type="number"],
        .field-row input[type="color"],
        .field-row select {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 5px 8px;
            flex: 1;
            min-width: 0;
        }
        .field-row input[type="color"] {
            width: 50px;
            height: 30px;
            flex: 0;
            padding: 2px;
            cursor: pointer;
        }
        .color-pair {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        .color-pair input[type="text"] {
            width: 80px;
            flex: 0;
        }

        .no-selection {
            color: #444;
            font-size: 13px;
            padding: 40px 20px;
            text-align: center;
        }

        /* --- Preview canvas --- */
        .preview-canvas {
            border: 1px solid #222;
            background: #0a0a0a;
            display: block;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <h1>Unit Editor</h1>

    <div class="toolbar">
        <div class="action-row">
            <button class="btn btn-action" id="reset-btn">Reset All</button>
            <button class="btn btn-play" id="apply-btn">Apply to Game</button>
            <button class="btn btn-save" id="default-btn" style="display:none">Save as Default</button>
        </div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" data-tab="wingmen">Wingmen</button>
        <button class="tab-btn" data-tab="enemies">Enemies</button>
        <button class="tab-btn" data-tab="speakers">Speakers</button>
    </div>

    <div class="tab-content">
        <div class="editor-layout">
            <div class="unit-list-panel">
                <h2 id="list-heading">Wingmen</h2>
                <div class="unit-list" id="unit-list"></div>
                <button class="add-unit-btn" id="add-unit-btn">+ Add Type</button>
            </div>
            <div class="detail-panel" id="detail-panel">
                <canvas class="preview-canvas" id="preview-canvas" width="300" height="120"></canvas>
                <div class="no-selection">Select a unit type to edit</div>
            </div>
        </div>
    </div>

<script src="tools.js"></script>
<script>
// ============================================================
// DATA
// ============================================================
let wingmenData = {};
let enemiesData = {};
let speakersData = {};
let wingmenDefaults = {};
let enemiesDefaults = {};
let speakersDefaults = {};
let shapes = {};

let activeTab = 'wingmen';
let selectedKey = null;

function strokeShape(c, verts, size) {
    c.beginPath();
    for (let i = 0; i < verts.length; i++) {
        if (i === 0) c.moveTo(verts[i][0]*size, verts[i][1]*size);
        else c.lineTo(verts[i][0]*size, verts[i][1]*size);
    }
    c.closePath(); c.stroke();
}

function getData() {
    if (activeTab === 'wingmen') return wingmenData;
    if (activeTab === 'enemies') return enemiesData;
    return speakersData;
}
function getDefaults() {
    if (activeTab === 'wingmen') return wingmenDefaults;
    if (activeTab === 'enemies') return enemiesDefaults;
    return speakersDefaults;
}

// ============================================================
// UNIT LIST
// ============================================================
const listEl = document.getElementById('unit-list');
const detailEl = document.getElementById('detail-panel');
const listHeading = document.getElementById('list-heading');

function renderList() {
    listEl.innerHTML = '';
    const data = getData();
    const keys = Object.keys(data);

    listHeading.textContent = activeTab === 'wingmen' ? 'Wingmen' : activeTab === 'enemies' ? 'Enemies' : 'Speakers';

    for (const key of keys) {
        const unit = data[key];
        const item = document.createElement('div');
        item.className = 'unit-item' + (key === selectedKey ? ' selected' : '');

        const swatch = document.createElement('span');
        swatch.className = 'swatch';
        swatch.style.background = unit.color;

        const name = document.createElement('span');
        name.className = 'name';
        name.textContent = key;

        const del = document.createElement('span');
        del.className = 'delete-unit';
        del.textContent = '\u00d7';
        del.onclick = (e) => {
            e.stopPropagation();
            delete data[key];
            if (selectedKey === key) selectedKey = null;
            renderList();
            renderDetail();
        };

        item.append(swatch, name, del);
        item.onclick = () => { selectedKey = key; renderList(); renderDetail(); };
        listEl.appendChild(item);
    }
}

// ============================================================
// DETAIL EDITOR
// ============================================================
function renderDetail() {
    const data = getData();
    // Keep canvas, clear the rest
    const canvas = document.getElementById('preview-canvas');
    detailEl.innerHTML = '';
    detailEl.appendChild(canvas);

    if (!selectedKey || !data[selectedKey]) {
        detailEl.innerHTML += '<div class="no-selection">Select a unit type to edit</div>';
        drawPreview();
        return;
    }

    const unit = data[selectedKey];

    const section = makeSection('Properties');

    // Key (id) — read-only display
    section.appendChild(fieldRow('Key', staticText(selectedKey)));

    if (activeTab === 'wingmen') {
        section.appendChild(fieldRow('Display Name', textInput(unit.name, v => { unit.name = v; })));
        section.appendChild(fieldRow('Color', colorInput(unit.color, v => { unit.color = v; renderList(); drawPreview(); })));
        section.appendChild(fieldRow('Fire Rate', numberInput(unit.fireRate, 1, 120, v => { unit.fireRate = v; })));
        section.appendChild(fieldRow('Target Priority', selectInput(unit.targetPriority, ['nearest', 'enemies'], v => { unit.targetPriority = v; })));
    } else if (activeTab === 'enemies') {
        section.appendChild(fieldRow('Color', colorInput(unit.color, v => { unit.color = v; renderList(); drawPreview(); })));
    } else {
        section.appendChild(fieldRow('Color', colorInput(unit.color, v => { unit.color = v; renderList(); drawPreview(); })));
    }

    detailEl.appendChild(section);
    drawPreview();
}

// ============================================================
// PREVIEW
// ============================================================
function drawPreview() {
    const canvas = document.getElementById('preview-canvas');
    const c = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    c.fillStyle = '#0a0a0a';
    c.fillRect(0, 0, w, h);

    const data = getData();
    if (!selectedKey || !data[selectedKey]) return;

    const unit = data[selectedKey];

    if (activeTab === 'speakers') {
        // Speaker preview: simulated dialogue box
        const label = selectedKey;
        c.fillStyle = unit.color;
        c.font = '13px Courier New';
        c.textAlign = 'left';
        c.fillText(label + ':', 20, h / 2 - 8);
        c.fillStyle = '#ccc';
        c.font = '12px Courier New';
        c.fillText('Sample dialogue text...', 20, h / 2 + 12);
    } else {
        const shape = activeTab === 'wingmen' ? shapes.wingman : shapes.enemy;
        if (!shape) return;
        const size = 20;

        c.save();
        c.translate(w / 2, h / 2);

        // Glow
        c.strokeStyle = unit.color;
        c.globalAlpha = 0.2;
        c.lineWidth = 2;
        c.beginPath();
        c.arc(0, 0, size + 10, 0, Math.PI * 2);
        c.stroke();

        // Shape
        c.globalAlpha = 1;
        c.strokeStyle = unit.color;
        c.lineWidth = 2;
        strokeShape(c, shape, size);

        c.restore();

        // Label
        c.fillStyle = unit.color;
        c.font = '11px Courier New';
        c.textAlign = 'center';
        const label = activeTab === 'wingmen' ? unit.name : selectedKey.toUpperCase();
        c.fillText(label, w / 2, h / 2 + size + 24);
    }
}

// ============================================================
// FORM HELPERS (tool-specific)
// ============================================================
function staticText(value) {
    const span = document.createElement('span');
    span.style.color = '#888';
    span.style.fontSize = '12px';
    span.textContent = value;
    return span;
}

function colorInput(value, onChange) {
    const wrapper = document.createElement('div');
    wrapper.className = 'color-pair';

    const picker = document.createElement('input');
    picker.type = 'color';
    picker.value = value;

    const text = document.createElement('input');
    text.type = 'text';
    text.value = value;

    picker.oninput = () => { text.value = picker.value; onChange(picker.value); };
    text.oninput = () => {
        if (/^#[0-9a-fA-F]{3,6}$/.test(text.value)) {
            picker.value = text.value.length === 4
                ? '#' + text.value[1]+text.value[1] + text.value[2]+text.value[2] + text.value[3]+text.value[3]
                : text.value;
            onChange(text.value);
        }
    };

    wrapper.append(picker, text);
    return wrapper;
}

// ============================================================
// ADD UNIT
// ============================================================
document.getElementById('add-unit-btn').onclick = () => {
    const data = getData();
    let key = 'new-type';
    let n = 1;
    while (data[key]) { key = 'new-type-' + (n++); }

    if (activeTab === 'wingmen') {
        data[key] = { name: key.toUpperCase(), color: '#fff', fireRate: 25, targetPriority: 'nearest' };
    } else {
        data[key] = { color: '#fff' };
    }
    // For speakers, use uppercase key convention
    if (activeTab === 'speakers') {
        const upper = key.toUpperCase();
        data[upper] = data[key];
        delete data[key];
        key = upper;
    }

    selectedKey = key;
    renderList();
    renderDetail();
};

// ============================================================
// TABS
// ============================================================
for (const btn of document.querySelectorAll('.tab-btn')) {
    btn.onclick = () => {
        document.querySelector('.tab-btn.active').classList.remove('active');
        btn.classList.add('active');
        activeTab = btn.dataset.tab;
        selectedKey = null;
        renderList();
        renderDetail();
    };
}

// ============================================================
// RESET
// ============================================================
document.getElementById('reset-btn').onclick = () => {
    wingmenData = JSON.parse(JSON.stringify(wingmenDefaults));
    enemiesData = JSON.parse(JSON.stringify(enemiesDefaults));
    speakersData = JSON.parse(JSON.stringify(speakersDefaults));
    selectedKey = null;
    renderList();
    renderDetail();
};

// ============================================================
// APPLY TO GAME
// ============================================================
document.getElementById('apply-btn').onclick = () => {
    localStorage.setItem('lf-mod-wingmen', JSON.stringify(wingmenData));
    localStorage.setItem('lf-mod-enemies', JSON.stringify(enemiesData));
    localStorage.setItem('lf-mod-speakers', JSON.stringify(speakersData));
    flashButton('apply-btn', 'Applied!');
};

// ============================================================
// SAVE AS DEFAULT (dev server only)
// ============================================================
setupSaveDefault('default-btn', () => Promise.all([
    saveJSON('/api/save-wingmen', wingmenData),
    saveJSON('/api/save-enemies', enemiesData),
    saveJSON('/api/save-speakers', speakersData)
]));

// ============================================================
// INIT
// ============================================================
async function init() {
    try {
        const [wingmenRes, enemiesRes, speakersRes, shapesRes] = await Promise.all([
            fetch('../data/wingmen.json'),
            fetch('../data/enemies.json'),
            fetch('../data/speakers.json'),
            fetch('../data/shapes.json')
        ]);
        wingmenDefaults = await wingmenRes.json();
        enemiesDefaults = await enemiesRes.json();
        speakersDefaults = await speakersRes.json();
        shapes = await shapesRes.json();
    } catch (e) {
        console.error('Failed to load unit data:', e);
    }

    // Start from defaults, then override with any existing mods
    wingmenData = JSON.parse(JSON.stringify(wingmenDefaults));
    enemiesData = JSON.parse(JSON.stringify(enemiesDefaults));
    speakersData = JSON.parse(JSON.stringify(speakersDefaults));
    try {
        const wmod = JSON.parse(localStorage.getItem('lf-mod-wingmen'));
        if (wmod && typeof wmod === 'object') wingmenData = wmod;
    } catch {}
    try {
        const emod = JSON.parse(localStorage.getItem('lf-mod-enemies'));
        if (emod && typeof emod === 'object') enemiesData = emod;
    } catch {}
    try {
        const smod = JSON.parse(localStorage.getItem('lf-mod-speakers'));
        if (smod && typeof smod === 'object') speakersData = smod;
    } catch {}

    renderList();
    renderDetail();
}

init();
</script>
</body>
</html>
