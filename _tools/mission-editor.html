<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mission Editor — Last Frontier</title>
    <link rel="stylesheet" href="tools.css">
    <style>
        body { padding: 20px; }
        h1 { margin-bottom: 16px; }
        h2 { margin-bottom: 8px; margin-top: 0; }
        .btn { font-size: 12px; padding: 6px 16px; }

        .toolbar {
            margin-bottom: 20px;
            border-bottom: 1px solid #222;
            padding-bottom: 12px;
        }

        .editor-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        /* --- Mission List Panel --- */
        .mission-list-panel {
            width: 240px;
            flex-shrink: 0;
        }
        .mission-list {
            border: 1px solid #222;
            background: #0a0a0a;
            min-height: 100px;
        }
        .mission-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            cursor: pointer;
            border-bottom: 1px solid #1a1a1a;
            user-select: none;
        }
        .mission-item:hover { background: #1a1a1a; }
        .mission-item.selected { background: #1a2a1a; border-left: 2px solid #4f4; }
        .mission-item.drag-over { border-top: 2px solid #4f4; }
        .mission-item .index {
            color: #555;
            font-size: 10px;
            width: 20px;
            flex-shrink: 0;
        }
        .mission-item .title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 12px;
        }
        .mission-item .objective-tag {
            font-size: 9px;
            padding: 1px 4px;
            border: 1px solid #444;
            color: #888;
            text-transform: uppercase;
            flex-shrink: 0;
        }
        .mission-item .objective-tag.boss { border-color: #f44; color: #f44; }
        .mission-item .objective-tag.survive { border-color: #fa4; color: #fa4; }
        .mission-item .delete-mission {
            color: #444;
            cursor: pointer;
            font-size: 14px;
            flex-shrink: 0;
            padding: 0 2px;
        }
        .mission-item .delete-mission:hover { color: #f44; }
        .mission-item .drag-handle {
            color: #333;
            cursor: grab;
            font-size: 12px;
            flex-shrink: 0;
        }
        .mission-item .drag-handle:hover { color: #888; }
        .add-mission-btn {
            width: 100%;
            padding: 8px;
            background: transparent;
            border: 1px dashed #333;
            color: #666;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            cursor: pointer;
        }
        .add-mission-btn:hover { border-color: #4f4; color: #4f4; }

        /* --- Detail Panel --- */
        .detail-panel {
            flex: 1;
            min-width: 0;
        }
        .detail-panel .section {
            border: 1px solid #222;
            padding: 14px 16px;
            margin-bottom: 12px;
        }
        .field-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .field-row label {
            width: 130px;
            flex-shrink: 0;
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
        }
        .field-row input[type="text"],
        .field-row input[type="number"],
        .field-row select {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 5px 8px;
            flex: 1;
            min-width: 0;
        }
        .field-row input[type="checkbox"] {
            accent-color: #4f4;
        }
        .checkbox-group {
            display: flex;
            gap: 12px;
            flex: 1;
        }
        .checkbox-group label {
            width: auto;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            color: #ccc;
            font-size: 12px;
            text-transform: none;
        }

        /* --- Dialogue Editor --- */
        .dialogue-editor {
            border: 1px solid #222;
            padding: 10px;
            margin-bottom: 12px;
        }
        .dialogue-entry {
            display: flex;
            gap: 6px;
            align-items: flex-start;
            margin-bottom: 6px;
        }
        .dialogue-entry input[type="text"] {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 4px 6px;
        }
        .dialogue-entry .speaker-input { width: 80px; flex-shrink: 0; }
        .dialogue-entry .text-input { flex: 1; min-width: 0; }
        .dialogue-entry .drag-handle {
            color: #333;
            cursor: grab;
            font-size: 11px;
            padding: 4px 2px;
        }
        .dialogue-entry .drag-handle:hover { color: #888; }
        .dialogue-entry .delete-line {
            color: #444;
            cursor: pointer;
            font-size: 13px;
            padding: 3px 2px;
        }
        .dialogue-entry .delete-line:hover { color: #f44; }
        .add-line-btn {
            background: transparent;
            border: 1px dashed #333;
            color: #666;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 4px 10px;
            cursor: pointer;
        }
        .add-line-btn:hover { border-color: #4f4; color: #4f4; }

        .no-selection {
            color: #444;
            font-size: 13px;
            padding: 40px 20px;
            text-align: center;
        }

        .action-row input[type="text"] { width: 120px; font-size: 12px; padding: 5px 8px; }
    </style>
</head>
<body>
    <h1>Mission Editor</h1>

    <div class="toolbar">
        <h2>Presets</h2>
        <div class="preset-row" id="presets"></div>
        <div class="action-row">
            <input type="text" id="preset-name" placeholder="my-missions">
            <button class="btn btn-save" id="save-btn">Save</button>
            <button class="btn btn-action" id="reset-all-btn">Reset All</button>
            <button class="btn btn-play" id="apply-btn">Apply to Game</button>
            <button class="btn btn-save" id="default-btn" style="display:none">Save as Default</button>
        </div>
    </div>

    <div class="editor-layout">
        <div class="mission-list-panel">
            <h2>Missions</h2>
            <div class="mission-list" id="mission-list"></div>
            <button class="add-mission-btn" id="add-mission-btn">+ Add Mission</button>
        </div>

        <div class="detail-panel" id="detail-panel">
            <div class="no-selection">Select a mission to edit</div>
        </div>
    </div>

<script>
// ============================================================
// DATA — loaded from data/missions.json (single source of truth)
// ============================================================
const DATA_URL = '../data/missions.json';

const MUSIC_TRACKS = ['combat', 'easy', 'scary', 'strategy', 'victory', 'you-lost', 'zen'];
const OBJECTIVES = ['clear', 'survive', 'boss'];
const ENEMY_TYPES = ['normal', 'corrupt'];
const WINGMAN_TYPES = ['sierra', 'tango'];

let DEFAULTS = [];   // filled by fetchDefaults()
let missions = [];
let selectedIndex = -1;

// ============================================================
// MISSION LIST
// ============================================================
const listEl = document.getElementById('mission-list');
const detailEl = document.getElementById('detail-panel');

let dragSrcIndex = null;

function renderList() {
    listEl.innerHTML = '';
    missions.forEach((m, i) => {
        const item = document.createElement('div');
        item.className = 'mission-item' + (i === selectedIndex ? ' selected' : '');
        item.draggable = true;
        item.dataset.index = i;

        const handle = document.createElement('span');
        handle.className = 'drag-handle';
        handle.textContent = '\u2261';

        const idx = document.createElement('span');
        idx.className = 'index';
        idx.textContent = i + 1;

        const title = document.createElement('span');
        title.className = 'title';
        title.textContent = m.title;

        const tag = document.createElement('span');
        tag.className = 'objective-tag' + (m.objective === 'boss' ? ' boss' : m.objective === 'survive' ? ' survive' : '');
        tag.textContent = m.objective;

        const del = document.createElement('span');
        del.className = 'delete-mission';
        del.textContent = '\u00d7';
        del.onclick = (e) => {
            e.stopPropagation();
            missions.splice(i, 1);
            if (selectedIndex >= missions.length) selectedIndex = missions.length - 1;
            if (selectedIndex < 0) selectedIndex = -1;
            renderList();
            renderDetail();
        };

        item.append(handle, idx, title, tag, del);

        item.onclick = () => { selectedIndex = i; renderList(); renderDetail(); };

        // Drag events
        item.addEventListener('dragstart', (e) => {
            dragSrcIndex = i;
            e.dataTransfer.effectAllowed = 'move';
            item.style.opacity = '0.4';
        });
        item.addEventListener('dragend', () => { item.style.opacity = ''; });
        item.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            item.classList.add('drag-over');
        });
        item.addEventListener('dragleave', () => { item.classList.remove('drag-over'); });
        item.addEventListener('drop', (e) => {
            e.preventDefault();
            item.classList.remove('drag-over');
            if (dragSrcIndex === null || dragSrcIndex === i) return;
            const moved = missions.splice(dragSrcIndex, 1)[0];
            missions.splice(i, 0, moved);
            // Track selection
            if (selectedIndex === dragSrcIndex) selectedIndex = i;
            else if (dragSrcIndex < selectedIndex && i >= selectedIndex) selectedIndex--;
            else if (dragSrcIndex > selectedIndex && i <= selectedIndex) selectedIndex++;
            dragSrcIndex = null;
            renderList();
            renderDetail();
        });

        listEl.appendChild(item);
    });
}

// ============================================================
// DETAIL EDITOR
// ============================================================
function renderDetail() {
    if (selectedIndex < 0 || selectedIndex >= missions.length) {
        detailEl.innerHTML = '<div class="no-selection">Select a mission to edit</div>';
        return;
    }

    const m = missions[selectedIndex];
    detailEl.innerHTML = '';

    // --- Core Properties ---
    const coreSection = makeSection('Properties');

    coreSection.appendChild(fieldRow('Title', textInput(m.title, v => { m.title = v; renderList(); })));
    coreSection.appendChild(fieldRow('Music', selectInput(m.music, MUSIC_TRACKS, v => { m.music = v; })));
    coreSection.appendChild(fieldRow('Objective', selectInput(m.objective, OBJECTIVES, v => {
        m.objective = v;
        renderList();
        renderDetail(); // re-render to show/hide surviveTime
    })));

    if (m.objective === 'survive') {
        coreSection.appendChild(fieldRow('Survive Time', numberInput(m.surviveTime || 60, 1, 600, v => { m.surviveTime = v; })));
    }

    detailEl.appendChild(coreSection);

    // --- Enemies & Asteroids ---
    const combatSection = makeSection('Combat');

    combatSection.appendChild(fieldRow('Asteroids', numberInput(m.asteroidCount, 0, 50, v => { m.asteroidCount = v; })));
    combatSection.appendChild(fieldRow('Asteroid Sizes', asteroidSizesCheckboxes(m)));
    combatSection.appendChild(fieldRow('Enemies', numberInput(m.enemies, 0, 50, v => { m.enemies = v; })));
    combatSection.appendChild(fieldRow('Spawn Interval', numberInput(m.enemySpawnInterval, 0, 1000, v => { m.enemySpawnInterval = v; })));
    combatSection.appendChild(fieldRow('Enemy Type', selectInput(m.enemyType, ENEMY_TYPES, v => { m.enemyType = v; })));

    detailEl.appendChild(combatSection);

    // --- Wingman ---
    const wingmanSection = makeSection('Wingman');

    const wingmanCheckRow = fieldRow('Available', null);
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = m.wingmanAvailable;
    cb.style.accentColor = '#4f4';
    cb.onchange = () => { m.wingmanAvailable = cb.checked; renderDetail(); };
    wingmanCheckRow.appendChild(cb);
    wingmanSection.appendChild(wingmanCheckRow);

    if (m.wingmanAvailable) {
        wingmanSection.appendChild(fieldRow('Type', selectInput(m.wingmanType || 'sierra', WINGMAN_TYPES, v => { m.wingmanType = v; })));
    }

    detailEl.appendChild(wingmanSection);

    // --- Briefing Dialogue ---
    const briefingSection = makeSection('Briefing Dialogue');
    briefingSection.appendChild(buildDialogueEditor(m.briefing, (updated) => { m.briefing = updated; }));
    detailEl.appendChild(briefingSection);

    // --- Completion Dialogue ---
    const completionSection = makeSection('Completion Dialogue');
    completionSection.appendChild(buildDialogueEditor(m.completionDialogue, (updated) => { m.completionDialogue = updated; }));
    detailEl.appendChild(completionSection);
}

// ============================================================
// FORM HELPERS
// ============================================================
function makeSection(title) {
    const div = document.createElement('div');
    div.className = 'section';
    const h = document.createElement('h2');
    h.textContent = title;
    div.appendChild(h);
    return div;
}

function fieldRow(labelText, inputEl) {
    const row = document.createElement('div');
    row.className = 'field-row';
    const lbl = document.createElement('label');
    lbl.textContent = labelText;
    row.appendChild(lbl);
    if (inputEl) row.appendChild(inputEl);
    return row;
}

function textInput(value, onChange) {
    const inp = document.createElement('input');
    inp.type = 'text';
    inp.value = value;
    inp.oninput = () => onChange(inp.value);
    return inp;
}

function numberInput(value, min, max, onChange) {
    const inp = document.createElement('input');
    inp.type = 'number';
    inp.value = value;
    inp.min = min;
    inp.max = max;
    inp.oninput = () => onChange(parseInt(inp.value) || 0);
    return inp;
}

function selectInput(value, options, onChange) {
    const sel = document.createElement('select');
    for (const opt of options) {
        const o = document.createElement('option');
        o.value = opt;
        o.textContent = opt;
        if (opt === value) o.selected = true;
        sel.appendChild(o);
    }
    sel.onchange = () => onChange(sel.value);
    return sel;
}

function asteroidSizesCheckboxes(mission) {
    const group = document.createElement('div');
    group.className = 'checkbox-group';
    const sizes = [
        { val: 3, label: 'Large' },
        { val: 2, label: 'Medium' },
        { val: 1, label: 'Small' }
    ];
    for (const s of sizes) {
        const lbl = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = mission.asteroidSizes.includes(s.val);
        cb.onchange = () => {
            if (cb.checked) {
                if (!mission.asteroidSizes.includes(s.val)) {
                    mission.asteroidSizes.push(s.val);
                    mission.asteroidSizes.sort((a, b) => b - a);
                }
            } else {
                mission.asteroidSizes = mission.asteroidSizes.filter(v => v !== s.val);
            }
        };
        lbl.append(cb, ' ' + s.label);
        group.appendChild(lbl);
    }
    return group;
}

// ============================================================
// DIALOGUE EDITOR
// ============================================================
function buildDialogueEditor(lines, onUpdate) {
    const container = document.createElement('div');
    container.className = 'dialogue-editor';

    let dragLineSrc = null;

    function rebuild() {
        container.innerHTML = '';
        lines.forEach((line, i) => {
            const entry = document.createElement('div');
            entry.className = 'dialogue-entry';
            entry.draggable = true;
            entry.dataset.lineIndex = i;

            const handle = document.createElement('span');
            handle.className = 'drag-handle';
            handle.textContent = '\u2261';

            const speaker = document.createElement('input');
            speaker.type = 'text';
            speaker.className = 'speaker-input';
            speaker.value = line.speaker;
            speaker.placeholder = 'SPEAKER';
            speaker.oninput = () => { line.speaker = speaker.value; onUpdate(lines); };

            const text = document.createElement('input');
            text.type = 'text';
            text.className = 'text-input';
            text.value = line.text;
            text.placeholder = 'Dialogue text...';
            text.oninput = () => { line.text = text.value; onUpdate(lines); };

            const del = document.createElement('span');
            del.className = 'delete-line';
            del.textContent = '\u00d7';
            del.onclick = () => {
                lines.splice(i, 1);
                onUpdate(lines);
                rebuild();
            };

            entry.append(handle, speaker, text, del);

            // Drag reorder
            entry.addEventListener('dragstart', (e) => {
                dragLineSrc = i;
                e.dataTransfer.effectAllowed = 'move';
                entry.style.opacity = '0.4';
            });
            entry.addEventListener('dragend', () => { entry.style.opacity = ''; });
            entry.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                entry.style.borderTop = '2px solid #4f4';
            });
            entry.addEventListener('dragleave', () => { entry.style.borderTop = ''; });
            entry.addEventListener('drop', (e) => {
                e.preventDefault();
                entry.style.borderTop = '';
                if (dragLineSrc === null || dragLineSrc === i) return;
                const moved = lines.splice(dragLineSrc, 1)[0];
                lines.splice(i, 0, moved);
                onUpdate(lines);
                dragLineSrc = null;
                rebuild();
            });

            container.appendChild(entry);
        });

        const addBtn = document.createElement('button');
        addBtn.className = 'add-line-btn';
        addBtn.textContent = '+ Add Line';
        addBtn.onclick = () => {
            lines.push({ speaker: 'HQ', text: '' });
            onUpdate(lines);
            rebuild();
            // Focus the new text input
            const entries = container.querySelectorAll('.dialogue-entry');
            const last = entries[entries.length - 1];
            if (last) last.querySelector('.text-input').focus();
        };
        container.appendChild(addBtn);
    }

    rebuild();
    return container;
}

// ============================================================
// ADD MISSION
// ============================================================
document.getElementById('add-mission-btn').onclick = () => {
    const newMission = {
        id: missions.length + 1,
        title: 'New Mission',
        music: 'combat',
        briefing: [{ speaker: 'HQ', text: '' }],
        asteroidCount: 4,
        asteroidSizes: [3],
        enemies: 0,
        enemySpawnInterval: 0,
        enemyType: 'normal',
        wingmanAvailable: false,
        wingmanType: null,
        objective: 'clear',
        surviveTime: null,
        completionDialogue: [{ speaker: 'HQ', text: '' }]
    };
    missions.push(newMission);
    selectedIndex = missions.length - 1;
    renderList();
    renderDetail();
};

// ============================================================
// PRESETS
// ============================================================
function loadPresets() {
    try { return JSON.parse(localStorage.getItem('mission-presets') || '{}'); } catch { return {}; }
}
function savePresets(p) { localStorage.setItem('mission-presets', JSON.stringify(p)); }

function renderPresets() {
    const row = document.getElementById('presets');
    row.innerHTML = '';
    const presets = loadPresets();
    for (const name of Object.keys(presets)) {
        const btn = document.createElement('button');
        btn.className = 'preset-btn';
        btn.innerHTML = `${name} <span class="delete">\u00d7</span>`;
        btn.querySelector('.delete').onclick = (e) => {
            e.stopPropagation();
            const p = loadPresets(); delete p[name]; savePresets(p); renderPresets();
        };
        btn.onclick = () => {
            missions = JSON.parse(JSON.stringify(presets[name]));
            selectedIndex = missions.length > 0 ? 0 : -1;
            renderList();
            renderDetail();
        };
        row.appendChild(btn);
    }
}

document.getElementById('save-btn').onclick = () => {
    const name = document.getElementById('preset-name').value.trim();
    if (!name) return;
    const presets = loadPresets();
    presets[name] = JSON.parse(JSON.stringify(missions));
    savePresets(presets);
    document.getElementById('preset-name').value = '';
    renderPresets();
};

document.getElementById('reset-all-btn').onclick = () => {
    missions = JSON.parse(JSON.stringify(DEFAULTS));
    selectedIndex = missions.length > 0 ? 0 : -1;
    renderList();
    renderDetail();
};

// ============================================================
// APPLY TO GAME
// ============================================================
document.getElementById('apply-btn').onclick = () => {
    // Reassign IDs based on position
    const output = missions.map((m, i) => ({ ...m, id: i + 1 }));
    localStorage.setItem('lf-mod-missions', JSON.stringify(output));
    const btn = document.getElementById('apply-btn');
    btn.textContent = 'Applied!';
    setTimeout(() => { btn.textContent = 'Apply to Game'; }, 1500);
};

// ============================================================
// SAVE AS DEFAULT (dev server only — writes JSON to data/missions.json)
// ============================================================
if (location.hostname === 'localhost' && location.port === '8080') {
    const defBtn = document.getElementById('default-btn');
    defBtn.style.display = '';
    defBtn.onclick = () => {
        const output = missions.map((m, i) => ({ ...m, id: i + 1 }));
        fetch('/api/save-missions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(output, null, 4)
        })
            .then(r => r.json())
            .then(() => { defBtn.textContent = 'Saved!'; })
            .catch(() => { defBtn.textContent = 'Error'; })
            .finally(() => setTimeout(() => { defBtn.textContent = 'Save as Default'; }, 1500));
    };
}

// ============================================================
// INIT — fetch defaults from data/missions.json, then render
// ============================================================
async function init() {
    try {
        const res = await fetch(DATA_URL);
        DEFAULTS = await res.json();
    } catch (e) {
        console.error('Failed to load missions data:', e);
        DEFAULTS = [];
    }

    // Start from defaults, then override with any existing mod
    missions = JSON.parse(JSON.stringify(DEFAULTS));
    try {
        const existing = JSON.parse(localStorage.getItem('lf-mod-missions'));
        if (Array.isArray(existing) && existing.length > 0) {
            missions = existing;
        }
    } catch {}

    selectedIndex = missions.length > 0 ? 0 : -1;
    renderList();
    renderDetail();
    renderPresets();
}

init();
</script>
</body>
</html>
